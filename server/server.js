const express = require('express');
const fs = require('fs')
const cors = require('cors');
const { MongoClient } = require('mongodb')
const app = express();
app.use(cors());
const port = 3000;

const url = 'mongodb://localhost:27017';
const dbName = 'finalProj';
const client = new MongoClient(url);

let collections = {
    all_homes: null,
    five_plus_bed: null,
    four_bed: null,
    one_bed: null,
    three_bed: null,
    two_bed: null,
};

let collectionsRental = {
    all_homes_rental: null,
    five_plus_bed_rental: null,
    four_bed_rental: null,
    one_bed_rental: null,
    three_bed_rental: null,
    two_bed_rental:null
};

app.get("/geojson", async (req, res) => {
     res.sendFile(__dirname + "/us-states.json")
})

app.get("/data", async (req, res) => {

    let results = {};
    let count = 0;

    // Projection to format the data for purchases
    for (const col in collections) {
        collections[col].aggregate( [
            { $project: { _id: 0, state: '$RegionName', data: {
                "2010-01-31": '$2010-01-31',
                "2010-02-28": '$2010-02-28',
                "2010-03-31": '$2010-03-31',
                "2010-04-30": '$2010-04-30',
                "2010-05-31": '$2010-05-31',
                "2010-06-30": '$2010-06-30',
                "2010-07-31": '$2010-07-31',
                "2010-08-31": '$2010-08-31',
                "2010-09-30": '$2010-09-30',
                "2010-10-31": '$2010-10-31',
                "2010-11-30": '$2010-11-30',
                "2010-12-31": '$2010-12-31',
                "2011-01-31": '$2011-01-31',
                "2011-03-31": '$2011-03-31',
                "2011-02-28": '$2011-02-28',
                "2011-04-30": '$2011-04-30',
                "2011-05-31": '$2011-05-31',
                "2011-06-30": '$2011-06-30',
                "2011-07-31": '$2011-07-31',
                "2011-08-31": '$2011-08-31',
                "2011-09-30": '$2011-09-30',
                "2011-10-31": '$2011-10-31',
                "2011-11-30": '$2011-11-30',
                "2011-12-31": '$2011-12-31',
                "2012-01-31": '$2012-01-31',
                "2012-02-29": '$2012-02-29',
                "2012-03-31": '$2012-03-31',
                "2012-04-30": '$2012-04-30',
                "2012-05-31": '$2012-05-31',
                "2012-06-30": '$2012-06-30',
                "2012-07-31": '$2012-07-31',
                "2012-08-31": '$2012-08-31',
                "2012-09-30": '$2012-09-30',
                "2012-10-31": '$2012-10-31',
                "2012-11-30": '$2012-11-30',
                "2012-12-31": '$2012-12-31',
                "2013-01-31": '$2013-01-31',
                "2013-02-28": '$2013-02-28',
                "2013-03-31": '$2013-03-31',
                "2013-04-30": '$2013-04-30',
                "2013-05-31": '$2013-05-31',
                "2013-06-30": '$2013-06-30',
                "2013-07-31": '$2013-07-31',
                "2013-08-31": '$2013-08-31',
                "2013-09-30": '$2013-09-30',
                "2013-10-31": '$2013-10-31',
                "2013-11-30": '$2013-11-30',
                "2013-12-31": '$2013-12-31',
                "2014-01-31": '$2014-01-31',
                "2014-02-28": '$2014-02-28',
                "2014-03-31": '$2014-03-31',
                "2014-04-30": '$2014-04-30',
                "2014-05-31": '$2014-05-31',
                "2014-06-30": '$2014-06-30',
                "2014-07-31": '$2014-07-31',
                "2014-08-31": '$2014-08-31',
                "2014-09-30": '$2014-09-30',
                "2014-10-31": '$2014-10-31',
                "2014-11-30": '$2014-11-30',
                "2014-12-31": '$2014-12-31',
                "2015-01-31": '$2015-01-31',
                "2015-02-28": '$2015-02-28',
                "2015-03-31": '$2015-03-31',
                "2015-04-30": '$2015-04-30',
                "2015-05-31": '$2015-05-31',
                "2015-06-30": '$2015-06-30',
                "2015-07-31": '$2015-07-31',
                "2015-08-31": '$2015-08-31',
                "2015-09-30": '$2015-09-30',
                "2015-10-31": '$2015-10-31',
                "2015-11-30": '$2015-11-30',
                "2015-12-31": '$2015-12-31',
                "2016-01-31": '$2016-01-31',
                "2016-02-29": '$2016-02-29',
                "2016-03-31": '$2016-03-31',
                "2016-04-30": '$2016-04-30',
                "2016-05-31": '$2016-05-31',
                "2016-06-30": '$2016-06-30',
                "2016-07-31": '$2016-07-31',
                "2016-08-31": '$2016-08-31',
                "2016-09-30": '$2016-09-30',
                "2016-10-31": '$2016-10-31',
                "2016-11-30": '$2016-11-30',
                "2016-12-31": '$2016-12-31',
                "2017-01-31": '$2017-01-31',
                "2017-02-28": '$2017-02-28',
                "2017-03-31": '$2017-03-31',
                "2017-04-30": '$2017-04-30',
                "2017-05-31": '$2017-05-31',
                "2017-06-30": '$2017-06-30',
                "2017-07-31": '$2017-07-31',
                "2017-08-31": '$2017-08-31',
                "2017-09-30": '$2017-09-30',
                "2017-10-31": '$2017-10-31',
                "2017-11-30": '$2017-11-30',
                "2017-12-31": '$2017-12-31',
                "2018-01-31": '$2018-01-31',
                "2018-02-28": '$2018-02-28',
                "2018-03-31": '$2018-03-31',
                "2018-04-30": '$2018-04-30',
                "2018-05-31": '$2018-05-31',
                "2018-06-30": '$2018-06-30',
                "2018-07-31": '$2018-07-31',
                "2018-08-31": '$2018-08-31',
                "2018-09-30": '$2018-09-30',
                "2018-10-31": '$2018-10-31',
                "2018-11-30": '$2018-11-30',
                "2018-12-31": '$2018-12-31',
                "2019-01-31": '$2019-01-31',
                "2019-02-28": '$2019-02-28',
                "2019-03-31": '$2019-03-31',
                "2019-04-30": '$2019-04-30',
                "2019-05-31": '$2019-05-31',
                "2019-06-30": '$2019-06-30',
                "2019-07-31": '$2019-07-31',
                "2019-08-31": '$2019-08-31',
                "2019-09-30": '$2019-09-30',
                "2019-10-31": '$2019-10-31',
                "2019-11-30": '$2019-11-30',
                "2019-12-31": '$2019-12-31',
            }}}
        ], {projection: {'_id': 0}}).toArray((e, r) => {
            if (e) throw e;
            results[col] = r;
            count++
        });
    }

    // Projection to format rental data
    for (const col in collectionsRental) {
        collectionsRental[col].aggregate( [
            { $project: { _id: 0, state: '$RegionName', data: {
                "2010-01": '$2010-01',
                "2010-02": '$2010-02',
                "2010-03": '$2010-03',
                "2010-04": '$2010-04',
                "2010-05": '$2010-05',
                "2010-06": '$2010-06',
                "2010-07": '$2010-07',
                "2010-08": '$2010-08',
                "2010-09": '$2010-09',
                "2010-10": '$2010-10',
                "2010-11": '$2010-11',
                "2010-12": '$2010-12',
                "2011-01": '$2011-01',
                "2011-02": '$2011-02',
                "2011-03": '$2011-03',
                "2011-04": '$2011-04',
                "2011-05": '$2011-05',
                "2011-06": '$2011-06',
                "2011-07": '$2011-07',
                "2011-08": '$2011-08',
                "2011-09": '$2011-09',
                "2011-10": '$2011-10',
                "2011-11": '$2011-11',
                "2011-12": '$2011-12',
                "2012-01": '$2012-01',
                "2012-02": '$2012-02',
                "2012-03": '$2012-03',
                "2012-04": '$2012-04',
                "2012-05": '$2012-05',
                "2012-06": '$2012-06',
                "2012-07": '$2012-07',
                "2012-08": '$2012-08',
                "2012-09": '$2012-09',
                "2012-10": '$2012-10',
                "2012-11": '$2012-11',
                "2012-12": '$2012-12',
                "2013-01": '$2013-01',
                "2013-02": '$2013-02',
                "2013-03": '$2013-03',
                "2013-04": '$2013-04',
                "2013-05": '$2013-05',
                "2013-06": '$2013-06',
                "2013-07": '$2013-07',
                "2013-08": '$2013-08',
                "2013-09": '$2013-09',
                "2013-10": '$2013-10',
                "2013-11": '$2013-11',
                "2013-12": '$2013-12',
                "2014-01": '$2014-01',
                "2014-02": '$2014-02',
                "2014-03": '$2014-03',
                "2014-04": '$2014-04',
                "2014-05": '$2014-05',
                "2014-06": '$2014-06',
                "2014-07": '$2014-07',
                "2014-08": '$2014-08',
                "2014-09": '$2014-09',
                "2014-10": '$2014-10',
                "2014-11": '$2014-11',
                "2014-12": '$2014-12',
                "2015-01": '$2015-01',
                "2015-02": '$2015-02',
                "2015-03": '$2015-03',
                "2015-04": '$2015-04',
                "2015-05": '$2015-05',
                "2015-06": '$2015-06',
                "2015-07": '$2015-07',
                "2015-08": '$2015-08',
                "2015-09": '$2015-09',
                "2015-10": '$2015-10',
                "2015-11": '$2015-11',
                "2015-12": '$2015-12',
                "2016-01": '$2016-01',
                "2016-02": '$2016-02',
                "2016-03": '$2016-03',
                "2016-04": '$2016-04',
                "2016-05": '$2016-05',
                "2016-06": '$2016-06',
                "2016-07": '$2016-07',
                "2016-08": '$2016-08',
                "2016-09": '$2016-09',
                "2016-10": '$2016-10',
                "2016-11": '$2016-11',
                "2016-12": '$2016-12',
                "2017-01": '$2017-01',
                "2017-02": '$2017-02',
                "2017-03": '$2017-03',
                "2017-04": '$2017-04',
                "2017-05": '$2017-05',
                "2017-06": '$2017-06',
                "2017-07": '$2017-07',
                "2017-08": '$2017-08',
                "2017-09": '$2017-09',
                "2017-10": '$2017-10',
                "2017-11": '$2017-11',
                "2017-12": '$2017-12',
                "2018-01": '$2018-01',
                "2018-02": '$2018-02',
                "2018-03": '$2018-03',
                "2018-04": '$2018-04',
                "2018-05": '$2018-05',
                "2018-06": '$2018-06',
                "2018-07": '$2018-07',
                "2018-08": '$2018-08',
                "2018-09": '$2018-09',
                "2018-10": '$2018-10',
                "2018-11": '$2018-11',
                "2018-12": '$2018-12',
                "2019-01": '$2019-01',
                "2019-02": '$2019-02',
                "2019-03": '$2019-03',
                "2019-04": '$2019-04',
                "2019-05": '$2019-05',
                "2019-06": '$2019-06',
                "2019-07": '$2019-07',
                "2019-08": '$2019-08',
                "2019-09": '$2019-09',
                "2019-10": '$2019-10',
                "2019-11": '$2019-11',
                "2019-12": '$2019-12',
            }}}
        ], {projection: {'_id': 0}}).toArray((e, r) => {
            if (e) throw e;
            results[col] = r;
            count++;

            // This ensures that the response is only sent after all the projections have finished.
            if (count === 12) {
                res.status(200);
                res.append('Context-Type', 'application/json');
                res.send(results);
            }
        });
    }
});


app.listen(port, () => {
     client.connect(function(err) {
          if (err) throw err;
          const db = client.db(dbName);
          for (const col in collections) {
              collections[col] = db.collection(col);
          }
          for (const col in collectionsRental) {
              collectionsRental[col] = db.collection(col);
          }
     });
     console.log(`App listening on port ${port}`)
});
